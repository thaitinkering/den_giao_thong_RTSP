import cv2, time
from PySide6.QtCore import QThread, Signal


class VideoThread(QThread):
    """Đọc RTSP trong thread riêng, phát frame BGR + FPS."""
    frame_ready = Signal(object)   # ndarray BGR
    fps_ready   = Signal(float)    # float

    def __init__(self, url, parent=None):
        super().__init__(parent)
        self.url = url

    def run(self):
        cap = cv2.VideoCapture(self.url, cv2.CAP_FFMPEG)
        if not cap.isOpened():
            print("❌ Không mở được RTSP:", self.url)
            return

        t0, cnt = time.time(), 0
        while not self.isInterruptionRequested():
            ret, frame = cap.read()
            if not ret:
                print("⚠️  Mất khung; thoát thread.")
                break

            self.frame_ready.emit(frame)
            cnt += 1
            now = time.time()
            if now - t0 >= 1.0:
                self.fps_ready.emit(cnt / (now - t0))
                t0, cnt = now, 0

        cap.release()
